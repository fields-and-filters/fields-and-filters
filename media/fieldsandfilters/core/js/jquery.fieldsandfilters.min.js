/**
 * @package     com_fieldsandfilters
 * @copyright   Copyright (C) 2012 KES - Kulka Tomasz . All rights reserved.
 * @license     GNU General Public License version 3 or later; see License.txt
 * @author      KES - Kulka Tomasz <kes@kextensions.com> - http://www.kextensions.com
 */

!function(e,t){var i=e[t]={$name:t,task:null,lastToken:null};e.fn[t]=function(t,s){var n=this;if(!n.length)return n;switch("object"==typeof t&&(s=t,t="filters"),t){case"pagination":s=e.extend(!0,{selector:"a"},s),i.pagination(n,s);break;case"reset":n.on("click",function(){e(i.selector("form")+":eq(0)").trigger("clear")});break;case"submit":e(i.selector("form")+":eq(0)").trigger("submit");break;case"random:all":n.on("click",function(s){s.preventDefault(),e(i.selector("form")+":eq(0)").trigger(t)});break;case"random:selected":n.on("click",function(t){t.preventDefault(),e(i.selector("form")+":eq(0)").trigger("random:selected")});break;case"filters":default:s=e.extend(!0,{selectors:{body:"#main",form:".faf-filters-form",input:".faf-filters-input",group:".faf-control-group",count:".faf-filters-count",reset:".faf-form-reset",fieldset:".faf-filters",empty:".faf-form-empty",submit:".faf-form-submit",random:".faf-form-random",other:"",loadingClass:"faf-filters-loading"},excluded:["view"],setCount:!0,hideCount:!0,hashNavigation:{enabled:!1,prefix:"#!"}},s),i.init(s),i.def("$request.modules",[]).push(i.get(s,"module",null)),i.set("$request.fields",e.merge(i.get("$request.fields",[]),i.get(s,"fields",[]))),i.del(s,["request","token","fields","selectors","fn"]),i.options(n,s),i.inputs(n),n.on({submit:function(t,s){t.preventDefault(),i.pagination("reset"),i.ajax(e(this),s)},clear:function(t,s){t.preventDefault(),s=!(s===!1||void 0===s),e.isEmptyObject(i.get("$data",{}))&&"random:selected"!=i.lastToken||(i.reset(e(this)),s||(e(i.selector("form")).not(e(this)).triggerHandler("reset",s),i.selector("other")&&i.reset(e(i.selector("other"),i.selector("body"))),e(this).triggerHandler("submit")))},"random:all":function(t){t.preventDefault(),e(i.selector("input")).each(function(){var t=Math.floor(10*Math.random())%2;e(this).prop(e(this).is("input")?"checked":"selected",t),t&&e(this).is(":disabled")&&e(this).prop("disabled",!1)}),i.task=t.type,e(this).triggerHandler("submit")},"random:selected":function(t){i.task=t.type,i.set("$data",{}),e(this).triggerHandler("submit")}}).removeClass(i.selector("loadingClass")).find([i.selector("reset"),i.selector("empty")].join()).on("click",function(e){e.preventDefault(),n.trigger("clear")}).filter(i.selector("empty")).hide()}return n},e.extend(i,{loading:function(t){switch(t=t||"start"){case"stop":e(this.selector("body")).removeClass(this.selector("loadingClass"));break;case"start":default:e(this.selector("body")).addClass(this.selector("loadingClass"))}},init:function(t){if(!this.get("$init")){this.set("$selectors",this.get(t,"selectors",{}));var s=e(this.selector("form")).map(function(){return e(this).is("[id]")||e(this).attr("id",(+new Date).toString(36)),e(this).attr("id")}).get();this.set("$forms",{first:s[0],last:s[s.length-1],all:s}),this.set("$request",this.get(t,"request",{})),this.paginationCache={},this.set("$pagination",this.get(t,"pagination",{})),this.set("$request",e.extend(this.get("$request",{}),this.get("$pagination",{}))),this.set("$data",{}),this.set("$url",this.get(t,"url","#")),this.token(this.get(t,"token",null)),this.fn(this.get(t,"fn",{})),this.selector("other")&&e(this.selector("body")).on("submit",this.selector("other"),function(t){return t.preventDefault(),e(this).fieldsandfilters("submit"),!1}),this.set("$excluded",e.merge(e.map(this.get("$request",{}),function(e,t){return t}),this.get(t,"excluded",[])));var n=this.hashNavigation=t.hashNavigation;t.hashNavigation.enabled&&(n.silent=!1,n.detected=!1,e(window).on("hashchange",function(){return n.silent?(n.detected=!0,void n.deferred.resolve()):void i.navigation()}),e(document).ready(function(){i.navigation()})),this.set("$init",!0)}},pagination:function(t,s,n){switch("object"==typeof t&&(n=s,s=t,t="get"),t){case"reset":this.paginationCache={},this.set("$request",e.extend(this.get("$request",{}),this.get("$pagination",{})));break;case"get":default:var a,r=Object.keys(this.get("$pagination",{}));s.on("click",this.get(n,"selector","a"),function(t){return t.preventDefault(),a=e(this).prop("search"),e.map(r,function(e){i.setPaginationParam(e,i.getURLParameter(a,e,0))}),i.ajax(),!1})}},setPaginationParam:function(e,t){var i=this.get("$pagination",{});return this.set("$request."+e,t),null===t||void 0===t||i[e]&&i[e]==t?void delete this.paginationCache[e]:void(this.paginationCache[e]=t)},get:function(e,t,i){var s,a,r,o=!1;if("object"!=typeof e&&(i=t,t=e,e=this),i=i||null,!t)return e;if(s=t.split("."))for(r=0,n=s.length;a=s[r],n>r;r++){if(!e.hasOwnProperty(a)){o=!1;break}e=e[a],o=!0}return o&&null!==e&&""!==e&&(i=e),i},set:function(e,t,i){var s,a,r,o=null;if("object"!=typeof e&&(i=t,t=e,e=this),s=t.split(".")){for(r=0,n=s.length-1;a=s[r],n>r;r++)e.hasOwnProperty(a)||r==n||(e[a]={}),e=e[a];o=e[a]=i}return o},def:function(e,t,i){return"object"!=typeof e&&(i=t,t=e,e=this),this.set(e,t,this.get(e,t,i))},del:function(t,s){var a,r=!0;if("object"!=typeof t&&(s=t,t=this),e.isArray(s))e.each(s,function(e,s){i.del(t,s)});else if(keys=s.split(".")){for(a=0,n=keys.length-1;key=keys[a],n>a;a++){if(!t.hasOwnProperty(key)&&a!=n){r=!1;break}t=t[key]}if(r)return delete t[key],!0}return!1},grep:function(e,t,i){for(var s in e)if(t.call(i||this,s,e[s]))return!0;return!1}}),e.extend(i,{requestID:function(e){var t=(+new Date).toString(32).toUpperCase();return e?this.set("$request.requestID",t):this.def("$request.requestID",t)},getURLParameter:function(e,t,i){return i=i||null,decodeURIComponent((new RegExp("[?|&]"+t+"=([^&;]+?)(&|#|;|$)").exec(e)||[,""])[1].replace(/\+/g,"%20"))||i},token:function(e){return e?this.set("$token",e):this.get("$token",null)},options:function(e,t){var i="$options."+e.attr("id");return"object"==typeof t?this.set(i,t):this.get(i,{})},selector:function(t,i){return e.trim(this.get("$selectors."+t,i||""))},ajax:function(t,s){s||(s={}),this.requestID(!0);var n={};if(t){var a=this.options(t),r=this.serialize();if(e.param(this.get("$data",{}))==e.param(r)&&"random:selected"!=i.lastToken)return!1;i.set("$data",{}),e.extend(!0,this.get("$data",{}),r),this.set(n,"module",i.get(a,"module",null))}if(e.extend(!0,n,this.get("$data",{}),this.get("$request",{})),this.set(n,i.token(),1),"random:selected"==i.task){var o=i.grep(n,function(e){return/^fieldsandfilters[\d+]*/.test(e)});if(!o)return!1;this.set(n,"random",1)}i.hashNavigation.enabled&&!s.disableHashNavigation&&this.setNewHash(this.encodeHash(),{silent:!0}),this.loading(),e.getJSON(this.get("$url","#"),n).done(function(s,n,a){if(i.requestID()!=i.get(s,"requestID"))return!1;var r=i.get(s,"empty",!1);return r&&"random:all"==i.task?void e(i.selector("form")+":eq(0)").trigger("random:all"):(t&&(i.set("$counts",i.get(s,"counts",[])),i.inputs(t,!0),r?t.find(i.selector("empty")+":hidden").show().end().find(i.selector("submit")+":visible").hide().end().find(i.selector("random")+":visible").hide():t.find(i.selector("empty")+":visible").hide().end().find(i.selector("submit")+":hidden").show().end().find(i.selector("random")+":hidden").show()),i.body(i.get(s,"body",null)),i.styles(i.get(s,"head.styleSheets"),i.get(s,"head.style")),e.when(i.scripts(i.get(s,"head.scripts"),i.get(s,"head.script"))).done(function(){i.selector("other")&&e(i.selector("body")).find(i.selector("other")).each(function(){this.submit=function(){e(this).trigger("submit")}}),i.loading("stop"),i.fn("done",[t,s,n,a])}),r||"random:selected"!=i.task||i.set("$data",{}),i.task!=i.lastToken&&(i.lastToken=i.task),void(i.task=null))}).fail(function(e,s,n){i.set("$data",{}),i.loading("stop"),i.fn("fail",[t,e,s,n])}).always(function(s,n,a){var r;switch(n){case"success":r=i.get(s,"token");break;case"error":default:r=i.get(e.parseJSON(s.responseText),"token")}i.token(r),i.fn("always",[t,s,n,a])})}}),e.extend(i,{navigation:function(){var t=i.decodeHash(),s=this.hashNavigation;if(t||s.detected){var n=e(this.selector("form")),a=e(this.selector("other")),r=!e.isEmptyObject(this.paginationCache),o=!1;if(e(n.add(a)).trigger("reset"),t){var l=Object.keys(this.get("$pagination",{}));s.detected=!0,e.each(t,function(t,s){if(-1!=e.inArray(t,l))return i.setPaginationParam(t,s),void(o=!0);var r=e(),c=n.find("[data-alias=%s]".replace("%s",t)),h=!1;c.length?(s=e.isArray(s)?s:[s],e.each(s,function(e,t){r=r.add(c.find("[data-alias=%s]".replace("%s",t)))})):(r=a.find("[name=%s]".replace("%s",t)),h=!0),r.length&&r.each(function(){var t=e(this);if(t.is(":checkbox")||t.is(":radio"))t.prop("checked",!0);else if(t.is("option")){var i=t.parents("select"),n=i.val();if(e.isArray(n)){var a=n.indexOf("");-1!=a&&(n=n.slice(a+1)),n.push(t.val())}else n=t.val();i.val(n)}else h&&t.val(s)})})}else s.detected=!1;var c=e.param(this.get("$data",{}))==e.param(this.serialize());c&&(o||r)?(r&&this.pagination("reset"),this.ajax(null,{disableHashNavigation:!0})):o?this.ajax(n.eq(0),{disableHashNavigation:!0}):n.eq(0).triggerHandler("submit",{disableHashNavigation:!0})}},decodeHash:function(t,i){i||(i=this.hashNavigation),t||(t=window.location.hash);var s=new RegExp(i.prefix+"(\\/[\\w-]+:[\\w:-]+)+","g"),n={};return s.test(t)?(s=new RegExp(i.prefix+"|\\/"),e.each(t.split(s),function(e,t){if(t){var i=t.split(":");n[i.shift()]=1===i.length?i[0]:i}}),e.isEmptyObject(n)?!1:n):!1},encodeHash:function(t){t||(t=this.hashNavigation);var i=e(this.selector("form")),s=this.serialize(i),n=[];return e.each(s,function(t,s){var a,r,o=i.find('[name="%s"]'.replace("%s",t)),l=o.is("select");if(o.length){if(e.isArray(s)||(s=[s]),a=o.parents("[data-alias]").data("alias"),!a)return;if(r=e.map(s,function(e){var t=o[l?"find":"filter"]('[value="%s"]'.replace("%s",e));return t.length?t.data("alias"):null}),e.isEmptyObject(r))return;r.unshift(a)}else r=[t,s];n.push(r.join(":"))}),e.isEmptyObject(this.paginationCache)||e.each(this.paginationCache,function(e,t){n.push([e,t].join(":"))}),e.isEmptyObject(n)?!1:t.prefix+"/"+n.join("/")},setNewHash:function(t,i){i||(i={});var s=this.hashNavigation;i.silent===!0&&(s.deferred=new e.Deferred,s.silent=!0),window.location.hash=t,e.when(s.deferred).done(function(){s.silent=!1})}}),e.extend(i,{styles:function(t,i){if("object"==typeof t&&!e.isEmptyObject(t)){var s=e("head link[href]").map(function(){return e(this).attr("href")});e.each(t,function(t,i){"string"==typeof t&&-1==e.inArray(t,s)&&e("<link/>").attr({href:t,rel:"stylesheet",type:i.mime,media:i.media?i.media:"screen"}).appendTo("head")})}"object"!=typeof i||e.isEmptyObject(i)||e.each(i,function(t,i){var s=document.createElement("style");s.type=t,s.styleSheet?s.styleSheet.cssText=i:s.appendChild(document.createTextNode(i)),e("head").append(s)})},scripts:function(t,i){var s=[];if("object"==typeof t&&!e.isEmptyObject(t)){var n=e("script[src]").map(function(){return e(this).attr("src")});e.each(t,function(t){"string"==typeof t&&-1==e.inArray(t,n)&&s.push(t)})}return e.when.apply(null,e.map(s,e.getScript)).done(function(){"object"!=typeof i||e.isEmptyObject(i)||e.each(i,function(t,i){var s=document.createElement("script");s.type=t,s.text=i,e("body").append(s)})})},body:function(t){t!==!1&&e(this.selector("body")).html(t)}}),e.extend(i,{$fn:{},$inputs:{},fn:function(t,s,n){var a;return n=n||"$fn.","object"==typeof t?(n=s||n,e.map(t,function(t,s){return{key:e.isFunction(t)?i.set(n+s,t):!1}})):e.isFunction(s)?i.set(n+t,s):(a=this.get(n+t))&&e.isFunction(a)?a.apply(i,e.isArray(s)?s:[s]):!1},inputs:function(t,s,n){var a,r,o,l=e(s?this.selector("form"):t),c=this.get("$inputs",{}),h=this.selector("input");return!e.isEmptyObject(c)&&h&&l.each(function(){o=e(this),a=i.options(o),r=o.find(h),e.each(c,function(t,n){e.isFunction(n)||delete c[t],n.apply(r,[o,a,s,i])})}),!n&&h?l.find(h):l},hash:function(e){var t,i=0;if(0==e.length)return i;for(t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i&=i;return i},serialize:function(t){var s,n={},a=this.get("$excluded",[]);return t=e(t||this.selector("form")),this.selector("other")&&(t=t.add(this.selector("other"),this.selector("body"))),e.each(t.serializeArray(),function(t,r){-1==e.inArray(r.name,a)&&((s=i.get(n,r.name))?(e.isArray(s)||(s=i.set(n,r.name,[s])),r.value&&s.push(r.value)):r.value&&i.set(n,r.name,r.value))}),n},reset:function(e){return e.find("input:text, input:password, input:file, select, textarea").val(""),e.find("input:radio, input:checkbox").removeAttr("checked").removeAttr("selected"),e},isSelectEnabled:function(t){return Boolean(e(t).parents("select").find(":enabled:not([data-default])").size())}}),i.fn({dataCount:function(t,s,n){var a,r=n?i.get("$counts",{}):i.get(s,"counts",{});e(this).each(function(){e(this).data("count",r.hasOwnProperty(a=e(this).val())?r[a]:0)})},setCount:function(){var t,s=i.selector("group"),n=i.selector("count");n&&n&&e(this).each(function(){t=e(this).data("count"),e(this).is("option")?e(this).text(e(this).text().replace(/(\()(?!.*\()\d+\)/g,"("+t+")")):e(this).parents(s).find(n).text(t!==!1?t:0)})},hideCount:function(){var t=i.selector("group");t&&e(this).each(function(){if(!e(this).data("default"))if(e(this).data("count")){if(e(this).attr("disabled",!1),e(this).is("option")&&!i.isSelectEnabled(this))return;e(this).parents(t).removeClass("faf-hide").show()}else{if(e(this).attr("disabled",!0),e(this).is("option")&&i.isSelectEnabled(this))return;e(this).parents(t).addClass("faf-hide").hide()}}).parents(i.selector("fieldset")).each(function(){var t=e(this).find(i.selector("input")+":enabled:not([data-default])").size(),s=e(this).is(":visible");!s&&t?e(this).show():s&&!t&&e(this).hide()})}},"$inputs.")}(jQuery,"fieldsandfilters");