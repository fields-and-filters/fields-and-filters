/**
 * @package     com_fieldsandfilters
 * @copyright   Copyright (C) 2012 KES - Kulka Tomasz . All rights reserved.
 * @license     GNU General Public License version 3 or later; see License.txt
 * @author      KES - Kulka Tomasz <kes@kextensions.com> - http://www.kextensions.com
 */

(function(c,a){var b=c[a]={$name:a,task:null};c.fn[a]=function(e,d){var f=this;if(!f.length){return f}if(typeof e==="object"){d=e;e="filters"}switch(e){case"pagination":d=c.extend(true,{selector:"a",pagination:"limitstart"},d);b.pagination(f,d);break;case"reset":f.on("click",function(){c(b.selector("form")+":eq(0)").trigger("clear")});break;case"submit":c(b.selector("form")+":eq(0)").trigger("submit");break;case"random:all":f.on("click",function(g){g.preventDefault();c(b.selector("form")+":eq(0)").trigger(e)});break;case"random:selected":f.on("click",function(g){g.preventDefault();c(b.selector("form")+":eq(0)").trigger("random:selected")});break;case"filters":default:d=c.extend(true,{selectors:{body:"#main",form:".faf-filters-form",input:".faf-filters-input",group:".faf-control-group",count:".faf-filters-count",reset:".faf-form-reset",fieldset:".faf-filters",empty:".faf-form-empty",submit:".faf-form-submit",other:"",loadingClass:"faf-filters-loading"},excluded:["view"],setCount:true,hideCount:true},d);b.init(d);b.def("$request.modules",[]).push(b.get(d,"module",null));b.set("$request.fields",c.merge(b.get("$request.fields",[]),b.get(d,"fields",[])));b.del(d,["request","token","fields","selectors","fn"]);b.options(f,d);b.inputs(f);f.on({submit:function(g){g.preventDefault();b.pagination("reset");b.ajax(c(this))},clear:function(h,g){h.preventDefault();g=!(g===false||g===undefined);if(c.isEmptyObject(b.get("$data",{}))){return}b.reset(c(this));if(!g){c(b.selector("form")).not(c(this)).triggerHandler("reset",g);if(b.selector("other")){b.reset(c(b.selector("other"),b.selector("body")))}c(this).triggerHandler("submit")}},"random:all":function(g){g.preventDefault();c(b.selector("input")).each(function(){var h=Math.floor(Math.random()*10)%2;c(this).prop(c(this).is("input")?"checked":"selected",h);if(h&&c(this).is(":disabled")){c(this).prop("disabled",false)}});b.task=g.type;c(this).triggerHandler("submit")},"random:selected":function(g){b.task=g.type;c(this).triggerHandler("submit")}}).removeClass(b.selector("loadingClass")).find([b.selector("reset"),b.selector("empty")].join()).on("click",function(g){g.preventDefault();f.trigger("clear")}).filter(b.selector("empty")).hide();break}return f};c.extend(b,{loading:function(d){d=d||"start";switch(d){case"stop":c(this.selector("body")).removeClass(this.selector("loadingClass"));break;case"start":default:c(this.selector("body")).addClass(this.selector("loadingClass"));break}},init:function(d){if(!this.get("$init")){this.set("$selectors",this.get(d,"selectors",{}));var e=c(this.selector("form")).map(function(){if(!c(this).is("[id]")){c(this).attr("id",(+new Date()).toString(36))}return c(this).attr("id")}).get();this.set("$forms",{first:e[0],last:e[e.length-1],all:e});this.set("$request",this.get(d,"request",{}));this.set("$pagination",this.get(d,"pagination",{}));this.set("$request",c.extend(this.get("$request",{}),this.get("$pagination",{})));this.set("$data",{});this.set("$url",this.get(d,"url","#"));this.token(this.get(d,"token",null));this.fn(this.get(d,"fn",{}));if(this.selector("other")){c(this.selector("body")).on("submit",this.selector("other"),function(f){f.preventDefault();c(this).fieldsandfilters("submit");return false})}this.set("$excluded",c.merge(c.map(this.get("$request",{}),function(f,g){return g}),this.get(d,"excluded",[])));this.set("$init",true)}},pagination:function(g,d,f){if(typeof g==="object"){f=d;d=g;g="get"}switch(g){case"reset":this.set("$request",c.extend(this.get("$request",{}),this.get("$pagination",{})));break;case"get":default:var e,h=this.get(f,"pagination",[]);h=c.isArray(h)?h:[h];d.on("click",this.get(f,"selector","a"),function(i){i.preventDefault();e=c(this).prop("search");c.map(h,function(j){b.set(("$request."+j),b.getURLParameter(e,j,0))});b.ajax();return false});break}},get:function(g,k,j){var h=false,f,e,d;if(typeof g!=="object"){j=k;k=g;g=this}j=j||null;if(!k){return g}else{if((f=k.split("."))){for(d=0,n=f.length;e=f[d],d<n;d++){if(g.hasOwnProperty(e)){g=g[e];h=true}else{h=false;break}}}}if(h&&g!==null&&g!==""){j=g}return j},set:function(h,k,j){var d=null,g,f,e;if(typeof h!=="object"){j=k;k=h;h=this}if((g=k.split("."))){for(e=0,n=g.length-1;f=g[e],e<n;e++){if(!h.hasOwnProperty(f)&&(e!=n)){h[f]={}}h=h[f]}d=h[f]=j}return d},def:function(d,f,e){if(typeof d!=="object"){e=f;f=d;d=this}return this.set(d,f,this.get(d,f,e))},del:function(e,g){var f=true,d;if(typeof e!=="object"){g=e;e=this}if(c.isArray(g)){c.each(g,function(h,j){b.del(e,j)})}else{if((keys=g.split("."))){for(d=0,n=keys.length-1;key=keys[d],d<n;d++){if(!e.hasOwnProperty(key)&&(d!=n)){f=false;break}e=e[key]}if(f){delete e[key];return true}}}return false},grep:function(f,g,e){for(var d in f){if(g.call(e||this,d,f[d])){return true}}return false}});c.extend(b,{requestID:function(d){var e=(+new Date()).toString(32).toUpperCase();return(d?this.set("$request.requestID",e):this.def("$request.requestID",e))},getURLParameter:function(e,d,f){f=f||null;return decodeURIComponent((new RegExp("[?|&]"+d+"=([^&;]+?)(&|#|;|$)").exec(e)||[,""])[1].replace(/\+/g,"%20"))||f},token:function(d){return(d?this.set("$token",d):this.get("$token",null))},options:function(d,f){var e="$options."+d.attr("id");return(typeof f==="object"?this.set(e,f):this.get(e,{}))},selector:function(d,e){return c.trim(this.get(("$selectors."+d),e||""))},ajax:function(e){this.requestID(true);var h={};if(e){var f=this.options(e),g=this.serialize();if(c.param(this.get("$data",{}))==c.param(g)){return false}b.set("$data",{});c.extend(true,this.get("$data",{}),g);this.set(h,"module",b.get(f,"module",null))}c.extend(true,h,this.get("$data",{}),this.get("$request",{}));this.set(h,b.token(),1);if(b.task=="random:selected"){var d=b.grep(h,function(i){return/^fieldsandfilters[\d+]*/.test(i)});if(!d){return false}this.set(h,"random",1)}this.loading();c.getJSON(this.get("$url","#"),h).done(function(k,i,j){if(b.requestID()!=b.get(k,"requestID")){return false}if(b.get(k,"empty",false)&&b.task=="random:all"){c(b.selector("form")+":eq(0)").trigger("random:all");return}if(e){b.set("$counts",b.get(k,"counts",[]));b.inputs(e,true);if(b.get(k,"empty",false)){e.find(b.selector("empty")+":hidden").show().end().find(b.selector("submit")+":visible").hide()}else{e.find(b.selector("empty")+":visible").hide().end().find(b.selector("submit")+":hidden").show()}}b.body(b.get(k,"body",null)),b.styles(b.get(k,"head.styleSheets"),b.get(k,"head.style"));c.when(b.scripts(b.get(k,"head.scripts"),b.get(k,"head.script"))).done(function(){if(b.selector("other")){c(b.selector("body")).find(b.selector("other")).each(function(){this.submit=function(){c(this).trigger("submit")}})}b.loading("stop");b.fn("done",[e,k,i,j])});if(b.task=="random:selected"){b.set("$data",{})}b.task=null}).fail(function(k,i,j){b.set("$data",{});b.loading("stop");b.fn("fail",[e,k,i,j])}).always(function(l,i,j){var k;switch(i){case"success":k=b.get(l,"token");break;case"error":default:k=b.get(c.parseJSON(l.responseText),"token");break}b.token(k);b.fn("always",[e,l,i,j])})}});c.extend(b,{styles:function(d,f){if(typeof d==="object"&&!c.isEmptyObject(d)){var e=c("head link[href]").map(function(){return c(this).attr("href")});c.each(d,function(g,h){if(typeof g==="string"&&c.inArray(g,e)==-1){c("<link/>").attr({href:g,rel:"stylesheet",type:h.mime,media:(h.media?h.media:"screen")}).appendTo("head")}})}if(typeof f==="object"&&!c.isEmptyObject(f)){c.each(f,function(h,i){var g=document.createElement("style");g.type=h;if(g.styleSheet){g.styleSheet.cssText=i}else{g.appendChild(document.createTextNode(i))}c("head").append(g)})}},scripts:function(e,f){var g=[];if(typeof e==="object"&&!c.isEmptyObject(e)){var d=c("script[src]").map(function(){return c(this).attr("src")});c.each(e,function(i,h){if(typeof i==="string"&&c.inArray(i,d)==-1){g.push(i)}})}return c.when.apply(null,c.map(g,c.getScript)).done(function(){if(typeof f==="object"&&!c.isEmptyObject(f)){c.each(f,function(i,j){var h=document.createElement("script");h.type=i;h.text=j;c("body").append(h)})}})},body:function(d){if(d!==false){c(this.selector("body")).html(d)}}});c.extend(b,{$fn:{},$inputs:{},fn:function(d,g,f){var e;f=f||"$fn.";if(typeof d==="object"){f=g||f;return c.map(d,function(i,h){return{key:(c.isFunction(i)?b.set((f+h),i):false)}})}else{if(c.isFunction(g)){return b.set((f+d),g)}else{if((e=this.get(f+d))&&c.isFunction(e)){return e.apply(b,(c.isArray(g)?g:[g]))}}}return false},inputs:function(l,g,h){var k,f,j,e=c(g?this.selector("form"):l),i=this.get("$inputs",{}),d=this.selector("input");if(!c.isEmptyObject(i)&&d){e.each(function(){j=c(this);k=b.options(j);f=j.find(d);c.each(i,function(m,o){if(!c.isFunction(o)){delete i[m]}o.apply(f,[j,k,g,b])})})}return(!h&&d?e.find(d):e)},hash:function(d){var f=0,e;if(d.length==0){return f}for(e=0;e<d.length;e++){f=((f<<5)-f)+d.charCodeAt(e);f=f&f}return f},serialize:function(d){var f={},g,e=this.get("$excluded",[]);d=c(d||this.selector("form"));if(this.selector("other")){d=d.add(this.selector("other"),this.selector("body"))}c.each(d.serializeArray(),function(h,i){if(c.inArray(i.name,e)!=-1){return}if((g=b.get(f,i.name))){if(!c.isArray(g)){g=b.set(f,i.name,[g])}if(i.value){g.push(i.value)}}else{if(i.value){b.set(f,i.name,i.value)}}});return f},reset:function(d){d.find("input:text, input:password, input:file, select, textarea").val("");d.find("input:radio, input:checkbox").removeAttr("checked").removeAttr("selected");return d},isSelectEnabled:function(d){return Boolean(c(d).parents("select").find(":enabled:not([data-default])").size())}});b.fn({dataCount:function(g,d,f){var e=(f?b.get("$counts",{}):b.get(d,"counts",{})),h;c(this).each(function(){c(this).data("count",e.hasOwnProperty(h=c(this).val())?e[h]:0)})},setCount:function(g,d,e){var h=b.selector("group"),i=b.selector("count"),f;if(i&&i){c(this).each(function(){f=c(this).data("count");if(c(this).is("option")){c(this).text(c(this).text().replace(/(\()(?!.*\()\d+\)/g,"("+f+")"))}else{c(this).parents(h).find(i).text(f!==false?f:0)}})}},hideCount:function(d,e){var f=b.selector("group");if(f){c(this).each(function(){if(c(this).data("default")){return}if(!c(this).data("count")){c(this).attr("disabled",true);if(c(this).is("option")&&b.isSelectEnabled(this)){return}c(this).parents(f).addClass("faf-hide").hide()}else{c(this).attr("disabled",false);if(c(this).is("option")&&!b.isSelectEnabled(this)){return}c(this).parents(f).removeClass("faf-hide").show()}}).parents(b.selector("fieldset")).each(function(){var g=c(this).find(b.selector("input")+":enabled:not([data-default])").size(),h=c(this).is(":visible");if(!h&&g){c(this).show()}else{if(h&&!g){c(this).hide()}}})}}},"$inputs.")})(jQuery,"fieldsandfilters");