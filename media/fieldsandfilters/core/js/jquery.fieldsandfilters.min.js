/**
 * @package     com_fieldsandfilters
 * @copyright   Copyright (C) 2012 KES - Kulka Tomasz . All rights reserved.
 * @license     GNU General Public License version 3 or later; see License.txt
 * @author      KES - Kulka Tomasz <kes@kextensions.com> - http://www.kextensions.com
 */

(function(e,t){var r=e[t]={$name:t};e.fn[t]=function(t,n){var i=this;if(!i.length){return i}if(typeof t==="object"){n=t;t="filters"}switch(t){case"pagination":n=e.extend(true,{selector:"a",pagination:"limitstart"},n);r.pagination(i,n);break;case"reset":i.on("click",function(){e(r.selector("form")+":eq(0)").trigger("clear")});break;case"submit":e(r.selector("form")+":eq(0)").trigger("submit");break;case"random":i.on("click",function(){e(r.selector("form")+":eq(0)").trigger("random")});break;case"filters":default:n=e.extend(true,{selectors:{body:"#main",form:".faf-filters-form",input:".faf-filters-input",group:".faf-control-group",count:".faf-filters-count",reset:".faf-form-reset",fieldset:".faf-filters",empty:".faf-form-empty",submit:".faf-form-submit",other:"",loadingClass:"faf-filters-loading"},excluded:["view"],setCount:true,hideCount:true},n);r.init(n);r.def("$request.modules",[]).push(r.get(n,"module",null));r.set("$request.fields",e.merge(r.get("$request.fields",[]),r.get(n,"fields",[])));r.del(n,["request","token","fields","selectors","fn"]);r.options(i,n);r.inputs(i);i.on({submit:function(t){t.preventDefault();r.pagination("reset");r.ajax(e(this))},clear:function(t,n){t.preventDefault();n=!(n===false||n===undefined);if(e.isEmptyObject(r.get("$data",{}))){return}r.reset(e(this));if(!n){e(r.selector("form")).not(e(this)).triggerHandler("reset",n);if(r.selector("other")){r.reset(e(r.selector("other"),r.selector("body")))}e(this).triggerHandler("submit")}},random:function(t){t.preventDefault();e(r.selector("input")).each(function(){var t=Math.floor(Math.random()*10)%2;e(this).prop(e(this).is("input")?"checked":"selected",t)})}}).removeClass(r.selector("loadingClass")).find([r.selector("reset"),r.selector("empty")].join()).on("click",function(e){e.preventDefault();i.trigger("clear")}).filter(r.selector("empty")).hide();break}return i};e.extend(r,{loading:function(t){t=t||"start";switch(t){case"stop":e(this.selector("body")).removeClass(this.selector("loadingClass"));break;case"start":default:e(this.selector("body")).addClass(this.selector("loadingClass"));break}},init:function(t){if(!this.get("$init")){this.set("$selectors",this.get(t,"selectors",{}));var n=e(this.selector("form")).map(function(){if(!e(this).is("[id]")){e(this).attr("id",(+(new Date)).toString(36))}return e(this).attr("id")}).get();this.set("$forms",{first:n[0],last:n[n.length-1],all:n});this.set("$request",this.get(t,"request",{}));this.set("$pagination",this.get(t,"pagination",{}));this.set("$request",e.extend(this.get("$request",{}),this.get("$pagination",{})));this.set("$data",{});this.set("$url",this.get(t,"url","#"));this.token(this.get(t,"token",null));this.fn(this.get(t,"fn",{}));if(this.selector("other")){e(this.selector("body")).on("submit",this.selector("other"),function(t){t.preventDefault();e(this).fieldsandfilters("submit");return false})}this.set("$excluded",e.merge(e.map(this.get("$request",{}),function(e,t){return t}),this.get(t,"excluded",[])));this.set("$init",true)}},pagination:function(t,n,i){if(typeof t==="object"){i=n;n=t;t="get"}switch(t){case"reset":this.set("$request",e.extend(this.get("$request",{}),this.get("$pagination",{})));break;case"get":default:var s;keys=this.get(i,"pagination",[]);keys=e.isArray(keys)?keys:[keys];n.on("click",this.get(i,"selector","a"),function(t){t.preventDefault();s=e(this).prop("search");e.map(keys,function(e){r.set("$request."+e,r.getURLParameter(s,e,0))});r.ajax();return false});break}},get:function(e,t,r){var i=false,s,o,u;if(typeof e!=="object"){r=t;t=e;e=this}r=r||null;if(!t){return e}else if(s=t.split(".")){for(u=0,n=s.length;o=s[u],u<n;u++){if(e.hasOwnProperty(o)){e=e[o];i=true}else{i=false;break}}}if(i&&e!==null&&e!==""){r=e}return r},set:function(e,t,r){var i=null,s,o,u;if(typeof e!=="object"){r=t;t=e;e=this}if(s=t.split(".")){for(u=0,n=s.length-1;o=s[u],u<n;u++){if(!e.hasOwnProperty(o)&&u!=n){e[o]={}}e=e[o]}i=e[o]=r}return i},def:function(e,t,n){if(typeof e!=="object"){n=t;t=e;e=this}return this.set(e,t,this.get(e,t,n))},del:function(t,i){var s=true,o;if(typeof t!=="object"){i=t;t=this}if(e.isArray(i)){e.each(i,function(e,n){r.del(t,n)})}else if(keys=i.split(".")){for(o=0,n=keys.length-1;key=keys[o],o<n;o++){if(!t.hasOwnProperty(key)&&o!=n){s=false;break}t=t[key]}if(s){delete t[key];return true}}return false}});e.extend(r,{requestID:function(e){var t=(+(new Date)).toString(32).toUpperCase();return e?this.set("$request.requestID",t):this.def("$request.requestID",t)},getURLParameter:function(e,t,n){n=n||null;return decodeURIComponent(((new RegExp("[?|&]"+t+"="+"([^&;]+?)(&|#|;|$)")).exec(e)||[,""])[1].replace(/\+/g,"%20"))||n},token:function(e){return e?this.set("$token",e):this.get("$token",null)},options:function(e,t){var n="$options."+e.attr("id");return typeof t==="object"?this.set(n,t):this.get(n,{})},selector:function(t,n){return e.trim(this.get("$selectors."+t,n||""))},ajax:function(t){this.requestID(true);var n={};if(t){var i=this.options(t),s=this.serialize();if(e.param(this.get("$data",{}))==e.param(s)){return false}r.set("$data",{});e.extend(true,this.get("$data",{}),s);this.set(n,"module",r.get(i,"module",null))}e.extend(true,n,this.get("$data",{}),this.get("$request",{}));this.set(n,r.token(),1);this.loading();e.getJSON(this.get("$url","#"),n).done(function(n,i,s){if(r.requestID()!=r.get(n,"requestID")){return false}if(t){r.set("$counts",r.get(n,"counts",[]));r.inputs(t,true);if(r.get(n,"empty",false)){t.find(r.selector("empty")+":hidden").show().end().find(r.selector("submit")+":visible").hide()}else{t.find(r.selector("empty")+":visible").hide().end().find(r.selector("submit")+":hidden").show()}}r.body(r.get(n,"body",null)),r.styles(r.get(n,"head.styleSheets"),r.get(n,"head.style"));e.when(r.scripts(r.get(n,"head.scripts"),r.get(n,"head.script"))).done(function(){if(r.selector("other")){e(r.selector("body")).find(r.selector("other")).each(function(){this.submit=function(){e(this).trigger("submit")}})}r.loading("stop");r.fn("done",[t,n,i,s])})}).fail(function(e,n,i){r.set("$data",{});r.loading("stop");r.fn("fail",[t,e,n,i])}).always(function(n,i,s){var o;switch(i){case"success":o=r.get(n,"token");break;case"error":default:o=r.get(e.parseJSON(n.responseText),"token");break}r.token(o);r.fn("always",[t,n,i,s])})}});e.extend(r,{styles:function(t,n){if(typeof t==="object"&&!e.isEmptyObject(t)){var r=e("head link[href]").map(function(){return e(this).attr("href")});e.each(t,function(t,n){if(typeof t==="string"&&e.inArray(t,r)==-1){e("<link/>").attr({href:t,rel:"stylesheet",type:n.mime,media:n.media?n.media:"screen"}).appendTo("head")}})}if(typeof n==="object"&&!e.isEmptyObject(n)){e.each(n,function(t,n){var r=document.createElement("style");r.type=t;if(r.styleSheet){r.styleSheet.cssText=n}else{r.appendChild(document.createTextNode(n))}e("head").append(r)})}},scripts:function(t,n){var r=[];if(typeof t==="object"&&!e.isEmptyObject(t)){var i=e("script[src]").map(function(){return e(this).attr("src")});e.each(t,function(t,n){if(typeof t==="string"&&e.inArray(t,i)==-1){r.push(t)}})}return e.when.apply(null,e.map(r,e.getScript)).done(function(){if(typeof n==="object"&&!e.isEmptyObject(n)){e.each(n,function(t,n){var r=document.createElement("script");r.type=t;r.text=n;e("body").append(r)})}})},body:function(t){if(t!==false){e(this.selector("body")).html(t)}}});e.extend(r,{$fn:{},$inputs:{},fn:function(t,n,i){var s;i=i||"$fn.";if(typeof t==="object"){i=n||i;return e.map(t,function(t,n){return{key:e.isFunction(t)?r.set(i+n,t):false}})}else if(e.isFunction(n)){return r.set(i+t,n)}else if((s=this.get(i+t))&&e.isFunction(s)){return s.apply(r,e.isArray(n)?n:[n])}return false},inputs:function(t,n,i){var s,o,u,a=e(n?this.selector("form"):t),f=this.get("$inputs",{}),l=this.selector("input");if(!e.isEmptyObject(f)&&l){a.each(function(){u=e(this);s=r.options(u);o=u.find(l);e.each(f,function(t,i){if(!e.isFunction(i)){delete f[t]}i.apply(o,[u,s,n,r])})})}return!i&&l?a.find(l):a},hash:function(e){var t=0,n;if(e.length==0){return t}for(n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n);t=t&t}return t},serialize:function(t){var n={},i,s=this.get("$excluded",[]);t=e(t||this.selector("form"));if(this.selector("other")){t=t.add(this.selector("other"),this.selector("body"))}e.each(t.serializeArray(),function(t,o){if(e.inArray(o.name,s)!=-1){return}if(i=r.get(n,o.name)){if(!e.isArray(i)){i=r.set(n,o.name,[i])}if(o.value){i.push(o.value)}}else if(o.value){r.set(n,o.name,o.value)}});return n},reset:function(e){e.find("input:text, input:password, input:file, select, textarea").val("");e.find("input:radio, input:checkbox").removeAttr("checked").removeAttr("selected");return e},isSelectEnabled:function(t){return Boolean(e(t).parents("select").find(":enabled:not([data-default])").size())}});r.fn({dataCount:function(t,n,i){var s=i?r.get("$counts",{}):r.get(n,"counts",{}),o;e(this).each(function(){e(this).data("count",s.hasOwnProperty(o=e(this).val())?s[o]:0)})},setCount:function(t,n,i){var s=r.selector("group"),o=r.selector("count"),u;if(o&&o){e(this).each(function(){u=e(this).data("count");if(e(this).is("option")){e(this).text(e(this).text().replace(/(\()(?!.*\()\d+\)/g,"("+u+")"))}else{e(this).parents(s).find(o).text(u!==false?u:0)}})}},hideCount:function(t,n){var i=r.selector("group");if(i){e(this).each(function(){if(e(this).data("default")){return}if(!e(this).data("count")){e(this).attr("disabled",true);if(e(this).is("option")&&r.isSelectEnabled(this)){return}e(this).parents(i).hide()}else{e(this).attr("disabled",false);if(e(this).is("option")&&!r.isSelectEnabled(this)){return}e(this).parents(i).show()}}).parents(r.selector("fieldset")).each(function(){var t=e(this).find(r.selector("input")+":enabled:not([data-default])").size();visible=e(this).is(":visible");if(!visible&&t){e(this).show()}else if(visible&&!t){e(this).hide()}})}}},"$inputs.")})(jQuery,"fieldsandfilters");